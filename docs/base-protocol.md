# 斗拱支付 - 基础协议规则

本文档记录斗拱支付接口的基础协议规则和请求响应模型。

## 协议规则

- 传输方式: 采用 HTTPS 传输
- 提交方式: 采用 POST 方法提交
- 数据格式: JSON
- 字符编码: UTF-8
- 超时时间: 过长请求请实现异步接口（具体超时时间以各接口文档为准）
- 签名算法: SHA256WithRSA（详见"签名验签"文档）
- 签名要求: 详见"签名验签"文档
- 接口与参数格式: 详见"API命名"（以官方文档为准）

## 请求/响应体模型

最近更新时间：2025.5.8

### 模型约定

- 数据格式：请求与返回统一使用 JSON（注意：图片上传接口例外，使用表单方式）。
- 请求参数：尽量使用 RAW-JSON 模式；URL 参数中禁止出现 JSON 数据。
- 字符编码：统一采用 UTF-8。
- 包体限制：最大 10MB；应避免过大请求体、过大响应体；文件传输尽量使用文件服务。
- 空响应体：避免出现。
- 参数位置：如 `sys_id`、`product_id` 等关键字段位置需固定，便于网关解析。

### HEADER 模型

- 必须设置：`Content-Type: application/json;charset=UTF-8`
- 否则可能返回错误：
```json
{"data":{"resp_code":"10000000","resp_desc":"无效参数"}}
```

### 请求模型（示例）

```json
{
  "sys_id": "huifu id",
  "sign": "签名串",
  "data": {
    "product_id": "SPINTP320939500790581",
    "sub_appid": "wxec280d4c8a1cc2ca"
  }
}
```

### 响应模型

- 业务系统返回的数据均在 `data` 中，不应出现多层返回码，避免接入方判断困难。
- 斗拱平台会在业务返回的基础上进行加签。
- 通信标识由 HTTP Code 表示接口层请求结果，并非业务状态；业务状态需解析 `data.resp_code`。

示例：
```json
{
  "data": {
    "resp_code": "00000100",
    "resp_desc": "交易正在处理中 cashCode:000 cashDesc:成功",
    "trade_type": "T_JSAPI",
    "resultCode": "SUCCESS"
  },
  "sign": "返回值签名串"
}
```

## 标准字段及返回码

最近更新时间：2024.11.29

### 常见字段限制

- 参数命名：所有请求参数、结果参数采用下划线命名法（snake_case），由小写英文字母组成；多单词以下划线分隔。如：`trade_type`。枚举值推荐使用数字或大写英文字母组成的下划线命名。
- 交易金额：默认人民币，接口中支付金额单位为【元】，参数值保留 2 位小数；对账单中的交易金额单位为【元】。
- 数值型规范：仅可使用简单数值类型（如 int）；考虑到精度与可读性，金额等建议使用 string 表达。
- 时间：统一为标准北京时间（东八区）。若商户系统非北京时间，需先换算到北京时间再上送。
- 范围：涉及范围取值，统一使用"左闭右开"，如：[1~100)。

### 常见字段

- data：数据
- sys_id：渠道商、代理商、商户的 huifu_id
- resp_code：业务返回码
- resp_desc：业务返回码描述
- sign：加签结果
- product_id：产品号（由汇付生成提供）

### 返回码

- HTTP Code：以下为网关层通信结果含义，业务状态以 `data.resp_code` 为准。
  - 200：正常访问
  - 404：服务不存在
  - 412：请求体包含非法字符
  - 500：后端服务器错误
  - 502：后端服务调用超时或连接失败
  - 512：API 网关 SHUTDOWN
  - 911：按 IP、商户 ID、API Key 等维度限流
  - 914：按接口总访问数限流拒绝
  - 912：安全封禁
  - 921：网关鉴权不通过
  - 922：验签不通过
  - 923：返回结果加签失败

## 接入步骤

斗拱平台基于云原生技术栈，围绕账户、支付、结算、终端等领域提供基础服务，包含丰富的 API 服务、统一访问控制、开发者站点、自助服务平台与工单系统，支持商户/服务商快速联调上线。

### 接入准备

开始接入 API 前，请先完成：
1) 协议签署
2) 快速入驻成为商户或服务商
3) 开始接入 API 进行开发

### 接入步骤

1) 协议签署：与销售确认支付能力与费率等事项，线下签署并提交盖章协议原件。
2) 申请渠道商号：向销售提交资料，开通后将以短信发送地址、账号、密码至渠道商联系人。
3) 申请自有渠道号：渠道商申请成为支付宝或/和微信的"服务商"。
4) 配置自有渠道号：将微信/支付宝生成的渠道号告知运营人员，由运营侧完成绑定。
5) 获取 RSA 秘钥：向运营提交 RSA 密钥申请并提供接收邮箱，运营生成后发送。
6) 调试接口：根据业务需求进行接口联调。

说明：为便捷接入，平台提供多语言 SDK。可根据平台属性选择、安装与部署，以简化开发。

## 本库实现映射

本节说明官方协议与本库实现的对应关系：

### 架构映射

- **配置管理**：`Core/DougongConfig` - 存储 api_key、rsa_private_key、rsa_public_key、base_uri
- **基础功能**：`Core/BaseCore` - 按需添加签名验签、请求封装等方法
- **请求处理**：`Traits/Request` - Guzzle HTTP 客户端封装
- **签名工具**：`Tools/SignTool` - 异步通知验签等功能
- **功能模块**：各功能文件夹 - 直接对应斗拱功能菜单，按需创建具体 PHP 文件

### 开发原则

- **最小化实现**：只有在真正需要时才添加方法和功能
- **直接对接**：无适配器层，直接调用斗拱 API
- **按需扩展**：功能模块文件夹已创建，具体实现按实际需求添加

### 实现示例

当需要实现"聚合正扫"接口时：
1. 在 `Payment/` 文件夹中创建 `Payment.php`
2. 继承 `BaseCore`，设置 `$endpoint = '/v3/trade/payment/jspay'`
3. 实现 `create()` 方法
4. 在 `BaseCore` 中按需添加签名、URL 设置等支持方法

## 备注

- 报文体字段 `data`、`sign` 为通用约定；具体字段与取值范围以各接口文档为准。
- 本库中的签名与验签实现将按需添加到 `Yourname\\DougongPay\\Core\\BaseCore` 与 `Yourname\\DougongPay\\Tools\\SignTool` 中，遵循最小化原则。